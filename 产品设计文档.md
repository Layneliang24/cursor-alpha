# Kibana日志分析工具产品设计文档

## 📋 产品概述

### 产品名称
**Kibana日志分析助手** (Kibana Log Analyzer)

### 产品定位
一款专为金融交易系统设计的Kibana日志分析GUI工具，提供便捷的日志查询、数据分析和风控监控功能。

### 目标用户
- 金融系统运维人员
- 风控分析师
- 技术支持工程师
- 系统管理员

## 🎯 核心功能

### 1. 基础设置模块
- **Kibana连接配置**
  - 服务器地址
  - 端口号
  - 认证信息（用户名/密码/API Key）
  - 连接测试功能
- **默认参数设置**
  - 默认时间范围
  - 默认索引模式
  - 查询超时时间
- **关键词配置**
  - 各功能模块的Kibana查询关键词
  - 字段映射配置
  - 结果解析规则

### 2. 客户盈亏计算模块
**功能描述**: 计算指定客户在特定时间范围内的股票盈亏
- **输入参数**
  - MemberID（必填）
  - 股票代码（必填）
  - 时间范围（可选，默认今日）
  - 索引名称（可选，默认配置）
- **输出结果**
  - 今日盈亏金额
  - 交易明细列表
  - 盈亏趋势图表

### 3. 风控日志查找模块
**功能描述**: 查询用户风控相关日志
- **输入参数**
  - 资产ID（必填）
  - 时间范围（必填）
  - 风控类型筛选（可选）
- **输出结果**
  - 风控触发记录
  - 风控规则详情
  - 处理状态跟踪

### 4. 资金流水日志查找模块
**功能描述**: 查询用户资金流水相关日志
- **输入参数**
  - MemberID（必填）
  - 时间范围（必填）
  - 资金类型筛选（可选）
- **输出结果**
  - 资金流水明细
  - 余额变动趋势
  - 异常交易标记

### 5. 持仓股票信息查找模块
**功能描述**: 查询用户持仓股票信息
- **输入参数**
  - MemberID（必填）
  - 时间范围（必填）
- **输出结果**
  - 持仓股票列表
  - 持仓成本
  - 当前市值
  - 盈亏情况

### 6. 购买力日志查找模块
**功能描述**: 查询用户购买力变动记录
- **输入参数**
  - MemberID（必填）
  - 时间范围（必填）
- **输出结果**
  - 购买力变动记录
  - 可用资金变化
  - 冻结资金明细

### 7. 条件单日志查找模块
**功能描述**: 查询用户条件单相关日志
- **输入参数**
  - MemberID（必填）
  - 时间范围（必填）
  - 条件单状态筛选（可选）
- **输出结果**
  - 条件单列表
  - 执行状态
  - 触发条件详情

## 🎨 界面设计

### 整体布局
- **左侧**: 功能模块选择区
- **右侧**: 参数输入和结果显示区
- **顶部**: 导航菜单
- **底部**: 状态栏

### 界面特点
- 简洁明了的设计风格
- 响应式布局，支持窗口缩放
- 直观的操作流程
- 丰富的数据可视化

### 主要界面模块

#### 1. 基础设置界面
```
┌─────────────────────────────────────────────────────────┐
│                    Kibana日志分析助手 v1.0               │
├─────────────────────────────────────────────────────────┤
│ 🔧 基础设置 │ 💰 盈亏计算 │ 🛡️ 风控日志 │ 💳 资金流水 │
│ 📊 持仓信息 │ 💪 购买力   │ ⏰ 条件单   │ 📈 数据分析 │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  🔗 Kibana连接配置                                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 服务器地址: [192.168.1.100] 端口: [5601]           │ │
│  │ 用户名: [admin]      密码: [********]              │ │
│  │ [🔍 测试连接] [💾 保存配置] [🔄 重置]              │ │
│  │ ✅ 连接状态: 已连接 | 响应时间: 45ms                │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  ⚙️ 默认参数设置                                        │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 默认时间范围: [今日 ▼] 默认索引: [logstash-*]      │ │
│  │ 查询超时: [30秒]      分页大小: [100条]            │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  🔑 关键词配置                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 功能模块 │ 查询关键词 │ 字段映射 │ 解析规则 │ 操作 │ │
│  │ 盈亏计算 │ memberId:* │ amount   │ 数值解析 │ [编辑]│ │
│  │ 风控日志 │ assetId:*  │ riskLevel│ 枚举解析 │ [编辑]│ │
│  │ 资金流水 │ memberId:* │ amount   │ 数值解析 │ [编辑]│ │
│  │ [➕ 添加配置] [📥 导入配置] [📤 导出配置]          │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

#### 2. 盈亏计算界面
```
┌─────────────────────────────────────────────────────────┐
│                    Kibana日志分析助手 v1.0               │
├─────────────────────────────────────────────────────────┤
│ 🔧 基础设置 │ 💰 盈亏计算 │ 🛡️ 风控日志 │ 💳 资金流水 │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  📊 查询参数                                            │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ MemberID: [12345]    股票代码: [AAPL]              │ │
│  │ 时间范围: [今日 ▼]   索引名称: [logstash-* ▼]      │ │
│  │ [🔍 查询] [📈 分析] [📤 导出] [🔄 重置]            │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  💰 计算结果                                            │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 📊 今日盈亏: +$1,234.56                             │ │
│  │ 📈 盈亏趋势图: [图表区域]                           │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  📋 交易明细                                            │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 时间 │ 类型 │ 数量 │ 价格 │ 金额 │ 盈亏 │ 状态 │    │ │
│  │ 09:30│ 买入 │ 100  │ 150.2│ 15020│ -    │ 成功 │    │ │
│  │ 14:20│ 卖出 │ 100  │ 162.8│ 16280│ +1260│ 成功 │    │ │
│  │ [上一页] [1/5] [下一页] [每页显示: 20条 ▼]          │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## 🔧 技术架构

### 前端技术栈
- **框架**: Electron + Vue.js 3
- **UI组件**: Element Plus
- **图表库**: ECharts
- **样式**: SCSS

### 后端技术栈
- **语言**: Node.js
- **HTTP客户端**: Axios
- **数据处理**: Lodash
- **配置管理**: Electron Store

### 核心模块设计

#### 1. 连接管理模块
```javascript
// kibana-connection.js
class KibanaConnection {
  constructor(config) {
    this.baseUrl = config.baseUrl;
    this.auth = config.auth;
    this.timeout = config.timeout || 30000;
    this.axios = axios.create({
      baseURL: this.baseUrl,
      timeout: this.timeout,
      headers: {
        'Content-Type': 'application/json',
        'kbn-xsrf': 'true'
      }
    });
  }

  async testConnection() {
    try {
      const response = await this.axios.get('/api/status');
      return { success: true, responseTime: response.responseTime };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  async executeQuery(query) {
    try {
      const response = await this.axios.post('/api/search', query);
      return { success: true, data: response.data };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }
}
```

#### 2. 查询模板模块
```javascript
// query-templates.js
class QueryTemplateManager {
  constructor() {
    this.templates = {
      profitLoss: {
        query: {
          index: 'logstash-*',
          body: {
            query: {
              bool: {
                must: [
                  { term: { memberId: '{{memberId}}' } },
                  { term: { stockCode: '{{stockCode}}' } },
                  { range: { timestamp: { gte: '{{startTime}}', lte: '{{endTime}}' } } }
                ]
              }
            },
            sort: [{ timestamp: { order: 'desc' } }],
            size: '{{size}}'
          }
        },
        fieldMapping: {
          amount: 'amount',
          type: 'tradeType',
          timestamp: 'timestamp'
        }
      }
    };
  }

  renderTemplate(templateName, params) {
    const template = this.templates[templateName];
    if (!template) throw new Error(`Template ${templateName} not found`);
    
    let queryString = JSON.stringify(template.query);
    Object.keys(params).forEach(key => {
      queryString = queryString.replace(new RegExp(`{{${key}}}`, 'g'), params[key]);
    });
    
    return JSON.parse(queryString);
  }
}
```

#### 3. 数据解析模块
```javascript
// data-parser.js
class DataParser {
  constructor() {
    this.parsers = {
      numeric: (value) => parseFloat(value) || 0,
      enum: (value, options) => options.includes(value) ? value : 'unknown',
      timestamp: (value) => new Date(value),
      string: (value) => String(value)
    };
  }

  parseResponse(response, fieldMapping, parseRules) {
    const hits = response.hits?.hits || [];
    return hits.map(hit => {
      const parsed = {};
      Object.keys(fieldMapping).forEach(field => {
        const sourceField = fieldMapping[field];
        const value = this.getNestedValue(hit._source, sourceField);
        const parseRule = parseRules[field] || 'string';
        parsed[field] = this.parsers[parseRule](value);
      });
      return parsed;
    });
  }

  getNestedValue(obj, path) {
    return path.split('.').reduce((current, key) => current?.[key], obj);
  }
}
```

## 📊 数据流程

### 查询流程
1. **用户输入参数** → 2. **参数验证** → 3. **查询模板渲染** → 4. **Kibana API调用** → 5. **数据解析** → 6. **结果展示**

### 错误处理
- 网络连接异常
- 认证失败
- 查询超时
- 数据格式错误
- 权限不足

## 🎯 用户体验设计

### 交互设计原则
1. **简洁明了**: 界面简洁，操作直观
2. **快速响应**: 查询结果快速返回
3. **错误友好**: 清晰的错误提示和解决建议
4. **数据可视化**: 图表展示，便于分析

### 快捷键支持
- `Ctrl + Enter`: 执行查询
- `Ctrl + S`: 保存配置
- `Ctrl + E`: 导出结果
- `F5`: 刷新数据

### 历史记录功能
- 保存最近10次查询
- 支持查询条件复用
- 查询结果缓存

## 🔒 安全设计

### 数据安全
- 敏感信息加密存储
- 连接信息本地保存
- 查询日志审计

### 权限控制
- 用户角色管理
- 功能模块权限
- 数据访问控制

## 📈 性能优化

### 查询优化
- 查询结果分页
- 数据缓存机制
- 异步查询处理

### 界面优化
- 虚拟滚动
- 懒加载
- 防抖处理

## 🚀 部署方案

### 打包发布
- Electron Builder打包
- 自动更新机制
- 安装程序制作

### 配置管理
- 配置文件热更新
- 多环境配置支持
- 配置导入导出

## 📋 开发计划

### Phase 1 (2周) - 基础框架搭建
- [ ] Electron项目初始化
- [ ] Vue.js 3集成
- [ ] Element Plus UI组件集成
- [ ] 基础项目结构搭建
- [ ] 开发环境配置

### Phase 2 (3周) - 核心功能开发
- [ ] Kibana连接模块
- [ ] 基础设置界面
- [ ] 盈亏计算模块
- [ ] 风控日志模块
- [ ] 资金流水模块

### Phase 3 (2周) - 高级功能开发
- [ ] 持仓信息模块
- [ ] 购买力模块
- [ ] 条件单模块
- [ ] 数据可视化集成

### Phase 4 (1周) - 优化完善
- [ ] 性能优化
- [ ] 错误处理完善
- [ ] 导出功能
- [ ] 测试用例编写

## 📞 技术支持

### 文档支持
- 用户使用手册
- API文档
- 故障排除指南

### 维护计划
- 定期功能更新
- Bug修复
- 性能优化

## 📄 许可证

MIT License

## 🤝 贡献指南

欢迎提交Issue和Pull Request来改进这个项目。

---

**版本**: v1.0  
**创建日期**: 2024-01-15  
**最后更新**: 2024-01-15
