# 部署运维 - 部署方案（阿里云 CentOS 7 / 2GB / 40GB）

> 目标：用最少资源与成本，实现 Docker 化 + Compose + CI/CD 的稳定上线。所有命令均为非交互式，适合自动化执行。

## 1. 服务器准备
- 系统：CentOS 7（已停止官方支持，固定依赖版本，关闭自动大升级）。
- 资源：2GB RAM / 40GB 磁盘；建议开启 1GB swap 以缓冲峰值。

```bash
# 基础依赖
sudo yum -y install yum-utils device-mapper-persistent-data lvm2

# 安装 Docker (推荐使用符合 CentOS7 的稳定版本)
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo yum -y install docker-ce docker-ce-cli containerd.io
sudo systemctl enable docker --now

# 安装 docker-compose（独立二进制）
sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 可选：创建 1GB swap
sudo fallocate -l 1G /swapfile && sudo chmod 600 /swapfile && sudo mkswap /swapfile && sudo swapon /swapfile
grep -q "/swapfile" /etc/fstab || echo "/swapfile swap swap defaults 0 0" | sudo tee -a /etc/fstab
```

## 2. 目录与环境
```bash
sudo mkdir -p /opt/alpha/{backend,frontend,nginx,logs,data}
sudo mkdir -p /opt/alpha/data/{mysql,redis,media,static}
sudo chown -R $USER:$USER /opt/alpha
```

准备 `.env`（参考仓库 `production.env.example`）：
```bash
cat > /opt/alpha/.env <<'ENV'
DJANGO_SECRET_KEY=please-change
DJANGO_DEBUG=False
DJANGO_ALLOWED_HOSTS=your.domain,localhost,127.0.0.1
CSRF_TRUSTED_ORIGINS=https://your.domain

MYSQL_HOST=mysql
MYSQL_PORT=3306
MYSQL_DB=alpha
MYSQL_USER=alpha
MYSQL_PASSWORD=alpha_pass

REDIS_HOST=redis
REDIS_PORT=6379

JWT_ACCESS_LIFETIME=3600
ENV
```

## 3. Docker Compose（生产最小版）
> 可复用仓库的 `docker-compose.prod.yml`，以下为最小对齐版（按需裁剪 ES 等）：

```yaml
version: '3.8'
services:
  mysql:
    image: mysql:8.0
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    environment:
      MYSQL_DATABASE: ${MYSQL_DB}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - /opt/alpha/data/mysql:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - /opt/alpha/data/redis:/data

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    env_file: /opt/alpha/.env
    depends_on:
      - mysql
      - redis
    volumes:
      - /opt/alpha/data/media:/app/media
      - /opt/alpha/data/static:/app/static
    command: ["sh", "-c", "python manage.py migrate --noinput && gunicorn alpha.wsgi:application -b 0.0.0.0:8000 --workers 2 --timeout 60"]

  celery:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    env_file: /opt/alpha/.env
    depends_on:
      - backend
      - redis
    command: ["sh", "-c", "celery -A alpha worker -l INFO --concurrency=1 --prefetch-multiplier=1"]

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    depends_on:
      - backend
    restart: unless-stopped

  nginx:
    image: nginx:1.25-alpine
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /opt/alpha/data/static:/static:ro
      - /opt/alpha/data/media:/media:ro
      - /opt/alpha/logs/nginx:/var/log/nginx
    ports:
      - "80:80"
      # - "443:443"  # 如配置TLS
    depends_on:
      - frontend
      - backend
```

## 4. Nginx 反向代理（示例）
仓库已有 `nginx.conf`，若自定义：
```nginx
server {
  listen 80;
  server_name your.domain;

  location /static/ { alias /static/; }
  location /media/  { alias /media/; }

  location /api/ {
    proxy_pass http://backend:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_read_timeout 60s;
  }

  location / {
    proxy_pass http://frontend:80;
    try_files $uri /index.html;
  }
}
```

> TLS：可用 nginx-proxy + acme-companion 或 certbot 非交互模式，注意 80/443 放行与定时续期。

## 5. 构建与上线
```bash
cd /opt/alpha/src  # 代码目录（git clone 到此）
docker-compose -f docker-compose.prod.yml pull || true
docker-compose -f docker-compose.prod.yml build --no-cache
docker-compose -f docker-compose.prod.yml up -d --remove-orphans

# 收集静态资源（如需）
docker-compose -f docker-compose.prod.yml exec -T backend python manage.py collectstatic --noinput
```

回滚：
```bash
docker-compose -f docker-compose.prod.yml rollback  # 如无该命令，使用上一个 tag 重新 up
```

## 6. CI/CD（GitHub Actions 示例）
```yaml
name: CI-CD
on:
  push:
    branches: [ main ]
jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '18' }
      - name: Frontend CI
        run: |
          cd frontend
          npm ci --no-audit --fund=false
          npm run build
          npm run test --if-present
      - name: Backend CI
        uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - run: |
          cd backend
          pip install -r requirements.txt
          pytest -q --maxfail=1 --disable-warnings
  deploy:
    needs: build-test
    runs-on: ubuntu-latest
    steps:
      - name: SSH Deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.ALPHA_HOST }}
          username: ${{ secrets.ALPHA_USER }}
          key: ${{ secrets.ALPHA_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            cd /opt/alpha/src
            git fetch --all --prune
            git checkout main
            git pull --rebase
            docker-compose -f docker-compose.prod.yml pull || true
            docker-compose -f docker-compose.prod.yml build --no-cache
            docker-compose -f docker-compose.prod.yml up -d --remove-orphans
```

## 7. 资源与优化
- Gunicorn workers=2、timeout=60；Celery concurrency=1、prefetch=1；限制文件上传大小与连接数。
- ES 关闭或 heap=512m；前端开启 gzip/br；静态资源强缓存；图片懒加载。

## 8. 备份与恢复
```bash
# 备份 MySQL
docker exec -i $(docker ps -qf name=mysql) mysqldump -ualpha -palpha_pass alpha | gzip > /opt/alpha/backups/alpha_$(date +%F).sql.gz

# 恢复 MySQL
gunzip -c /opt/alpha/backups/alpha_YYYY-MM-DD.sql.gz | docker exec -i $(docker ps -qf name=mysql) mysql -ualpha -palpha_pass alpha

# 媒体文件
rsync -a /opt/alpha/data/media/ /backup/media/
```

## 9. 监控与日志
- 监控：容器存活、HTTP 5xx、队列堆积、磁盘/内存/CPU；Prometheus Node/Container/Custom 指标。
- 日志：Nginx/后端/Celery 滚动；保留7-14天；错误告警（邮件/钉钉/企业微信）。

（本方案与仓库现有 Dockerfile/Docker Compose 对齐，按资源约束做了保守参数与可选组件策略。）


