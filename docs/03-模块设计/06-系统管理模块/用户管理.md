# 系统管理模块 - 用户管理

## 1. 用户管理概述

### 1.1 功能定位
用户管理是系统管理模块的核心组件，负责用户账户的创建、维护、权限分配和安全管理。

### 1.2 核心价值
- **用户生命周期管理**：从注册到注销的完整用户管理
- **安全控制**：确保系统安全和数据保护
- **权限集成**：与权限系统无缝集成
- **用户体验**：提供友好的用户管理界面

### 1.3 功能架构
```
用户管理系统
├── 用户账户管理
│   ├── 用户注册
│   ├── 用户认证
│   ├── 密码管理
│   └── 账户状态管理
├── 用户信息管理
│   ├── 基本信息
│   ├── 扩展信息
│   ├── 偏好设置
│   └── 头像管理
├── 用户权限管理
│   ├── 角色分配
│   ├── 权限分配
│   ├── 权限继承
│   └── 权限审计
└── 用户安全管理
    ├── 登录安全
    ├── 密码策略
    ├── 会话管理
    └── 安全日志
```

## 2. 用户数据模型

### 2.1 用户基础模型
```python
from django.contrib.auth.models import AbstractUser
from django.db import models

class User(AbstractUser):
    """扩展用户模型"""
    # 基础信息
    phone = models.CharField(max_length=20, blank=True, null=True)
    avatar = models.ImageField(upload_to='avatars/', blank=True, null=True)
    bio = models.TextField(max_length=500, blank=True)
    birth_date = models.DateField(blank=True, null=True)
    
    # 状态信息
    is_verified = models.BooleanField(default=False)
    email_verified_at = models.DateTimeField(blank=True, null=True)
    phone_verified_at = models.DateTimeField(blank=True, null=True)
    
    # 安全信息
    last_login_ip = models.GenericIPAddressField(blank=True, null=True)
    password_changed_at = models.DateTimeField(blank=True, null=True)
    failed_login_attempts = models.IntegerField(default=0)
    locked_until = models.DateTimeField(blank=True, null=True)
    
    # 偏好设置
    timezone = models.CharField(max_length=50, default='Asia/Shanghai')
    language = models.CharField(max_length=10, default='zh-hans')
    theme = models.CharField(max_length=20, default='light')
    
    # 时间戳
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'users'
```

### 2.2 用户配置模型
```python
class UserProfile(models.Model):
    """用户扩展配置"""
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='profile')
    
    # 个人信息
    real_name = models.CharField(max_length=100, blank=True)
    company = models.CharField(max_length=200, blank=True)
    position = models.CharField(max_length=100, blank=True)
    website = models.URLField(blank=True)
    location = models.CharField(max_length=100, blank=True)
    
    # 社交信息
    github_username = models.CharField(max_length=100, blank=True)
    linkedin_url = models.URLField(blank=True)
    twitter_username = models.CharField(max_length=100, blank=True)
    
    # 学习偏好
    learning_goals = models.JSONField(default=list)
    skill_tags = models.JSONField(default=list)
    interests = models.JSONField(default=list)
    
    # 通知设置
    email_notifications = models.BooleanField(default=True)
    push_notifications = models.BooleanField(default=True)
    reminder_notifications = models.BooleanField(default=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'user_profiles'
```

### 2.3 用户登录日志模型
```python
class UserLoginLog(models.Model):
    """用户登录日志"""
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='login_logs')
    ip_address = models.GenericIPAddressField()
    user_agent = models.TextField()
    device_type = models.CharField(max_length=50, blank=True)
    browser = models.CharField(max_length=100, blank=True)
    os = models.CharField(max_length=100, blank=True)
    location = models.CharField(max_length=200, blank=True)
    login_time = models.DateTimeField(auto_now_add=True)
    logout_time = models.DateTimeField(blank=True, null=True)
    session_duration = models.DurationField(blank=True, null=True)
    is_successful = models.BooleanField(default=True)
    failure_reason = models.CharField(max_length=200, blank=True)
    
    class Meta:
        db_table = 'user_login_logs'
        ordering = ['-login_time']
```

## 3. 用户管理功能

### 3.1 用户注册与认证

#### 3.1.1 用户注册
```python
from django.contrib.auth.hashers import make_password
from django.core.mail import send_mail
from django.utils.crypto import get_random_string

class UserRegistrationService:
    def __init__(self):
        pass
    
    def register_user(self, user_data: dict) -> dict:
        """用户注册"""
        try:
            # 验证数据
            self._validate_registration_data(user_data)
            
            # 创建用户
            user = User.objects.create(
                username=user_data['username'],
                email=user_data['email'],
                password=make_password(user_data['password']),
                is_active=False  # 需要邮箱验证
            )
            
            # 创建用户配置
            UserProfile.objects.create(user=user)
            
            # 发送验证邮件
            self._send_verification_email(user)
            
            return {
                'success': True,
                'user_id': user.id,
                'message': '注册成功，请查收验证邮件'
            }
            
        except Exception as e:
            return {
                'success': False,
                'error': str(e)
            }
    
    def _validate_registration_data(self, data: dict):
        """验证注册数据"""
        # 检查用户名是否存在
        if User.objects.filter(username=data['username']).exists():
            raise ValueError('用户名已存在')
        
        # 检查邮箱是否存在
        if User.objects.filter(email=data['email']).exists():
            raise ValueError('邮箱已被注册')
        
        # 验证密码强度
        if not self._is_strong_password(data['password']):
            raise ValueError('密码强度不够')
    
    def _is_strong_password(self, password: str) -> bool:
        """验证密码强度"""
        if len(password) < 8:
            return False
        
        has_upper = any(c.isupper() for c in password)
        has_lower = any(c.islower() for c in password)
        has_digit = any(c.isdigit() for c in password)
        has_special = any(c in '!@#$%^&*()_+-=[]{}|;:,.<>?' for c in password)
        
        return sum([has_upper, has_lower, has_digit, has_special]) >= 3
    
    def _send_verification_email(self, user: User):
        """发送验证邮件"""
        token = get_random_string(32)
        
        # 保存验证token（这里简化处理，实际应该用专门的模型）
        user.verification_token = token
        user.save()
        
        verification_url = f"http://localhost:3000/verify-email?token={token}"
        
        send_mail(
            '验证您的邮箱',
            f'请点击以下链接验证您的邮箱：{verification_url}',
            'noreply@alpha.com',
            [user.email],
            fail_silently=False,
        )
```

#### 3.1.2 用户认证
```python
from django.contrib.auth import authenticate
from rest_framework_simplejwt.tokens import RefreshToken

class UserAuthenticationService:
    def __init__(self):
        pass
    
    def login(self, username: str, password: str, request) -> dict:
        """用户登录"""
        try:
            # 检查账户锁定状态
            user = User.objects.filter(username=username).first()
            if user and self._is_account_locked(user):
                return {
                    'success': False,
                    'error': '账户已被锁定，请稍后再试'
                }
            
            # 认证用户
            user = authenticate(username=username, password=password)
            
            if user:
                if not user.is_active:
                    return {
                        'success': False,
                        'error': '账户未激活'
                    }
                
                # 重置失败次数
                user.failed_login_attempts = 0
                user.last_login_ip = self._get_client_ip(request)
                user.save()
                
                # 生成JWT token
                refresh = RefreshToken.for_user(user)
                access_token = refresh.access_token
                
                # 记录登录日志
                self._log_login_attempt(user, request, True)
                
                return {
                    'success': True,
                    'tokens': {
                        'access': str(access_token),
                        'refresh': str(refresh)
                    },
                    'user': {
                        'id': user.id,
                        'username': user.username,
                        'email': user.email
                    }
                }
            else:
                # 登录失败处理
                if user:
                    self._handle_login_failure(user)
                
                self._log_login_attempt(None, request, False, '用户名或密码错误')
                
                return {
                    'success': False,
                    'error': '用户名或密码错误'
                }
                
        except Exception as e:
            return {
                'success': False,
                'error': f'登录失败: {str(e)}'
            }
    
    def _is_account_locked(self, user: User) -> bool:
        """检查账户是否被锁定"""
        if user.locked_until and user.locked_until > timezone.now():
            return True
        return False
    
    def _handle_login_failure(self, user: User):
        """处理登录失败"""
        user.failed_login_attempts += 1
        
        # 失败次数达到阈值时锁定账户
        if user.failed_login_attempts >= 5:
            user.locked_until = timezone.now() + timedelta(minutes=30)
        
        user.save()
    
    def _get_client_ip(self, request):
        """获取客户端IP"""
        x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
        if x_forwarded_for:
            ip = x_forwarded_for.split(',')[0]
        else:
            ip = request.META.get('REMOTE_ADDR')
        return ip
    
    def _log_login_attempt(self, user: User, request, is_successful: bool, failure_reason: str = ''):
        """记录登录尝试"""
        UserLoginLog.objects.create(
            user=user,
            ip_address=self._get_client_ip(request),
            user_agent=request.META.get('HTTP_USER_AGENT', ''),
            is_successful=is_successful,
            failure_reason=failure_reason
        )
```

### 3.2 用户信息管理

#### 3.2.1 用户信息服务
```python
class UserProfileService:
    def __init__(self):
        pass
    
    def get_user_profile(self, user_id: int) -> dict:
        """获取用户完整信息"""
        try:
            user = User.objects.select_related('profile').get(id=user_id)
            
            return {
                'id': user.id,
                'username': user.username,
                'email': user.email,
                'phone': user.phone,
                'avatar': user.avatar.url if user.avatar else None,
                'bio': user.bio,
                'birth_date': user.birth_date,
                'is_verified': user.is_verified,
                'timezone': user.timezone,
                'language': user.language,
                'theme': user.theme,
                'profile': {
                    'real_name': user.profile.real_name,
                    'company': user.profile.company,
                    'position': user.profile.position,
                    'website': user.profile.website,
                    'location': user.profile.location,
                    'github_username': user.profile.github_username,
                    'learning_goals': user.profile.learning_goals,
                    'skill_tags': user.profile.skill_tags,
                    'interests': user.profile.interests,
                    'email_notifications': user.profile.email_notifications,
                    'push_notifications': user.profile.push_notifications,
                    'reminder_notifications': user.profile.reminder_notifications,
                }
            }
            
        except User.DoesNotExist:
            raise ValueError('用户不存在')
    
    def update_user_profile(self, user_id: int, profile_data: dict) -> bool:
        """更新用户信息"""
        try:
            user = User.objects.get(id=user_id)
            profile = user.profile
            
            # 更新用户基础信息
            for field in ['phone', 'bio', 'birth_date', 'timezone', 'language', 'theme']:
                if field in profile_data:
                    setattr(user, field, profile_data[field])
            
            user.save()
            
            # 更新扩展信息
            for field in ['real_name', 'company', 'position', 'website', 'location', 
                         'github_username', 'learning_goals', 'skill_tags', 'interests',
                         'email_notifications', 'push_notifications', 'reminder_notifications']:
                if field in profile_data:
                    setattr(profile, field, profile_data[field])
            
            profile.save()
            
            return True
            
        except Exception as e:
            logger.error(f"更新用户信息失败: {e}")
            return False
    
    def upload_avatar(self, user_id: int, avatar_file) -> dict:
        """上传用户头像"""
        try:
            user = User.objects.get(id=user_id)
            
            # 删除旧头像
            if user.avatar:
                user.avatar.delete()
            
            # 保存新头像
            user.avatar = avatar_file
            user.save()
            
            return {
                'success': True,
                'avatar_url': user.avatar.url
            }
            
        except Exception as e:
            return {
                'success': False,
                'error': str(e)
            }
```

## 4. 用户管理API

### 4.1 用户管理视图
```python
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from django.contrib.auth import get_user_model

User = get_user_model()

class UserViewSet(viewsets.ModelViewSet):
    queryset = User.objects.all()
    serializer_class = UserSerializer
    permission_classes = [IsAuthenticated]
    
    def get_queryset(self):
        """根据权限过滤用户列表"""
        if self.request.user.has_perm('system.user.manage'):
            return User.objects.all()
        else:
            return User.objects.filter(id=self.request.user.id)
    
    @action(detail=False, methods=['get', 'put'])
    def profile(self, request):
        """获取/更新当前用户信息"""
        profile_service = UserProfileService()
        
        if request.method == 'GET':
            profile_data = profile_service.get_user_profile(request.user.id)
            return Response(profile_data)
        
        elif request.method == 'PUT':
            success = profile_service.update_user_profile(
                request.user.id, 
                request.data
            )
            
            if success:
                return Response({'message': '信息更新成功'})
            else:
                return Response(
                    {'error': '更新失败'}, 
                    status=status.HTTP_400_BAD_REQUEST
                )
    
    @action(detail=False, methods=['post'])
    def upload_avatar(self, request):
        """上传头像"""
        if 'avatar' not in request.FILES:
            return Response(
                {'error': '请选择头像文件'}, 
                status=status.HTTP_400_BAD_REQUEST
            )
        
        profile_service = UserProfileService()
        result = profile_service.upload_avatar(
            request.user.id, 
            request.FILES['avatar']
        )
        
        if result['success']:
            return Response(result)
        else:
            return Response(result, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=False, methods=['post'])
    def change_password(self, request):
        """修改密码"""
        old_password = request.data.get('old_password')
        new_password = request.data.get('new_password')
        
        if not request.user.check_password(old_password):
            return Response(
                {'error': '原密码错误'}, 
                status=status.HTTP_400_BAD_REQUEST
            )
        
        # 验证新密码强度
        auth_service = UserAuthenticationService()
        if not auth_service._is_strong_password(new_password):
            return Response(
                {'error': '新密码强度不够'}, 
                status=status.HTTP_400_BAD_REQUEST
            )
        
        request.user.set_password(new_password)
        request.user.password_changed_at = timezone.now()
        request.user.save()
        
        return Response({'message': '密码修改成功'})
    
    @action(detail=False, methods=['get'])
    def login_history(self, request):
        """获取登录历史"""
        logs = UserLoginLog.objects.filter(
            user=request.user
        )[:20]  # 最近20条记录
        
        serializer = UserLoginLogSerializer(logs, many=True)
        return Response(serializer.data)
```

## 5. 前端用户管理界面

### 5.1 用户信息组件
```vue
<template>
  <div class="user-profile">
    <el-card>
      <template #header>
        <div class="card-header">
          <span>个人信息</span>
          <el-button 
            type="primary" 
            size="small" 
            @click="editMode = !editMode"
          >
            {{ editMode ? '取消' : '编辑' }}
          </el-button>
        </div>
      </template>
      
      <div class="profile-content">
        <!-- 头像区域 -->
        <div class="avatar-section">
          <el-avatar 
            :size="100" 
            :src="userProfile.avatar" 
            :icon="UserFilled"
          />
          <el-upload
            v-if="editMode"
            :action="uploadUrl"
            :headers="{ Authorization: `Bearer ${token}` }"
            :show-file-list="false"
            :on-success="handleAvatarSuccess"
            accept="image/*"
          >
            <el-button size="small" type="text">更换头像</el-button>
          </el-upload>
        </div>
        
        <!-- 基本信息 -->
        <el-form 
          :model="userProfile" 
          :rules="profileRules" 
          ref="profileFormRef"
          label-width="100px"
          :disabled="!editMode"
        >
          <el-form-item label="用户名" prop="username">
            <el-input v-model="userProfile.username" disabled />
          </el-form-item>
          
          <el-form-item label="邮箱" prop="email">
            <el-input v-model="userProfile.email" disabled />
          </el-form-item>
          
          <el-form-item label="真实姓名" prop="real_name">
            <el-input v-model="userProfile.profile.real_name" />
          </el-form-item>
          
          <el-form-item label="手机号" prop="phone">
            <el-input v-model="userProfile.phone" />
          </el-form-item>
          
          <el-form-item label="公司" prop="company">
            <el-input v-model="userProfile.profile.company" />
          </el-form-item>
          
          <el-form-item label="职位" prop="position">
            <el-input v-model="userProfile.profile.position" />
          </el-form-item>
          
          <el-form-item label="个人网站" prop="website">
            <el-input v-model="userProfile.profile.website" />
          </el-form-item>
          
          <el-form-item label="所在地" prop="location">
            <el-input v-model="userProfile.profile.location" />
          </el-form-item>
          
          <el-form-item label="个人简介" prop="bio">
            <el-input 
              v-model="userProfile.bio" 
              type="textarea" 
              :rows="4"
            />
          </el-form-item>
          
          <el-form-item label="时区" prop="timezone">
            <el-select v-model="userProfile.timezone">
              <el-option 
                v-for="tz in timezones" 
                :key="tz.value" 
                :label="tz.label" 
                :value="tz.value"
              />
            </el-select>
          </el-form-item>
          
          <el-form-item label="语言" prop="language">
            <el-select v-model="userProfile.language">
              <el-option label="简体中文" value="zh-hans" />
              <el-option label="English" value="en" />
            </el-select>
          </el-form-item>
          
          <el-form-item label="主题" prop="theme">
            <el-radio-group v-model="userProfile.theme">
              <el-radio value="light">浅色</el-radio>
              <el-radio value="dark">深色</el-radio>
              <el-radio value="auto">跟随系统</el-radio>
            </el-radio-group>
          </el-form-item>
          
          <el-form-item v-if="editMode">
            <el-button type="primary" @click="saveProfile" :loading="saving">
              保存
            </el-button>
          </el-form-item>
        </el-form>
      </div>
    </el-card>
    
    <!-- 通知设置 -->
    <el-card class="mt-4">
      <template #header>
        <span>通知设置</span>
      </template>
      
      <el-form :model="userProfile.profile" label-width="150px">
        <el-form-item label="邮件通知">
          <el-switch v-model="userProfile.profile.email_notifications" />
        </el-form-item>
        
        <el-form-item label="推送通知">
          <el-switch v-model="userProfile.profile.push_notifications" />
        </el-form-item>
        
        <el-form-item label="提醒通知">
          <el-switch v-model="userProfile.profile.reminder_notifications" />
        </el-form-item>
      </el-form>
    </el-card>
    
    <!-- 安全设置 -->
    <el-card class="mt-4">
      <template #header>
        <span>安全设置</span>
      </template>
      
      <div class="security-section">
        <el-button @click="showPasswordDialog = true">修改密码</el-button>
        <el-button @click="showLoginHistory = true">登录历史</el-button>
      </div>
    </el-card>
    
    <!-- 修改密码对话框 -->
    <el-dialog 
      title="修改密码" 
      v-model="showPasswordDialog" 
      width="400px"
    >
      <el-form 
        :model="passwordForm" 
        :rules="passwordRules" 
        ref="passwordFormRef"
      >
        <el-form-item label="原密码" prop="old_password">
          <el-input 
            v-model="passwordForm.old_password" 
            type="password" 
            show-password
          />
        </el-form-item>
        
        <el-form-item label="新密码" prop="new_password">
          <el-input 
            v-model="passwordForm.new_password" 
            type="password" 
            show-password
          />
        </el-form-item>
        
        <el-form-item label="确认密码" prop="confirm_password">
          <el-input 
            v-model="passwordForm.confirm_password" 
            type="password" 
            show-password
          />
        </el-form-item>
      </el-form>
      
      <template #footer>
        <el-button @click="showPasswordDialog = false">取消</el-button>
        <el-button 
          type="primary" 
          @click="changePassword" 
          :loading="changingPassword"
        >
          确认修改
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script>
import { ref, reactive, onMounted } from 'vue'
import { ElMessage } from 'element-plus'
import { UserFilled } from '@element-plus/icons-vue'
import api from '@/api/user'
import { useUserStore } from '@/stores/user'

export default {
  name: 'UserProfile',
  setup() {
    const userStore = useUserStore()
    const editMode = ref(false)
    const saving = ref(false)
    const showPasswordDialog = ref(false)
    const changingPassword = ref(false)
    const profileFormRef = ref()
    const passwordFormRef = ref()
    
    const userProfile = ref({
      username: '',
      email: '',
      phone: '',
      avatar: '',
      bio: '',
      timezone: 'Asia/Shanghai',
      language: 'zh-hans',
      theme: 'light',
      profile: {
        real_name: '',
        company: '',
        position: '',
        website: '',
        location: '',
        email_notifications: true,
        push_notifications: true,
        reminder_notifications: true
      }
    })
    
    const passwordForm = reactive({
      old_password: '',
      new_password: '',
      confirm_password: ''
    })
    
    const profileRules = {
      phone: [
        { pattern: /^1[3-9]\d{9}$/, message: '请输入正确的手机号', trigger: 'blur' }
      ],
      website: [
        { type: 'url', message: '请输入正确的网址', trigger: 'blur' }
      ]
    }
    
    const passwordRules = {
      old_password: [
        { required: true, message: '请输入原密码', trigger: 'blur' }
      ],
      new_password: [
        { required: true, message: '请输入新密码', trigger: 'blur' },
        { min: 8, message: '密码长度不能少于8位', trigger: 'blur' }
      ],
      confirm_password: [
        { required: true, message: '请确认新密码', trigger: 'blur' },
        { 
          validator: (rule, value, callback) => {
            if (value !== passwordForm.new_password) {
              callback(new Error('两次输入的密码不一致'))
            } else {
              callback()
            }
          }, 
          trigger: 'blur' 
        }
      ]
    }
    
    const timezones = [
      { label: '北京时间 (UTC+8)', value: 'Asia/Shanghai' },
      { label: '东京时间 (UTC+9)', value: 'Asia/Tokyo' },
      { label: '纽约时间 (UTC-5)', value: 'America/New_York' },
      { label: '伦敦时间 (UTC+0)', value: 'Europe/London' }
    ]
    
    const loadProfile = async () => {
      try {
        const response = await api.getProfile()
        userProfile.value = response.data
      } catch (error) {
        ElMessage.error('加载用户信息失败')
      }
    }
    
    const saveProfile = async () => {
      try {
        await profileFormRef.value.validate()
        
        saving.value = true
        await api.updateProfile(userProfile.value)
        
        ElMessage.success('信息保存成功')
        editMode.value = false
        
        // 更新store中的用户信息
        userStore.updateProfile(userProfile.value)
        
      } catch (error) {
        ElMessage.error('保存失败')
      } finally {
        saving.value = false
      }
    }
    
    const handleAvatarSuccess = (response) => {
      userProfile.value.avatar = response.avatar_url
      ElMessage.success('头像上传成功')
    }
    
    const changePassword = async () => {
      try {
        await passwordFormRef.value.validate()
        
        changingPassword.value = true
        await api.changePassword(passwordForm)
        
        ElMessage.success('密码修改成功')
        showPasswordDialog.value = false
        
        // 重置表单
        Object.keys(passwordForm).forEach(key => {
          passwordForm[key] = ''
        })
        
      } catch (error) {
        ElMessage.error(error.response?.data?.error || '密码修改失败')
      } finally {
        changingPassword.value = false
      }
    }
    
    onMounted(() => {
      loadProfile()
    })
    
    return {
      userProfile,
      passwordForm,
      editMode,
      saving,
      showPasswordDialog,
      changingPassword,
      profileFormRef,
      passwordFormRef,
      profileRules,
      passwordRules,
      timezones,
      UserFilled,
      uploadUrl: '/api/v1/users/upload_avatar/',
      token: userStore.token,
      loadProfile,
      saveProfile,
      handleAvatarSuccess,
      changePassword
    }
  }
}
</script>

<style scoped>
.user-profile {
  max-width: 800px;
  margin: 0 auto;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.profile-content {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.avatar-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.security-section {
  display: flex;
  gap: 10px;
}

.mt-4 {
  margin-top: 1rem;
}
</style>
```

## 6. 总结

用户管理模块提供了完整的用户生命周期管理功能，包括注册、认证、信息管理和安全控制。通过与权限系统的集成，确保了系统的安全性和可管理性。
