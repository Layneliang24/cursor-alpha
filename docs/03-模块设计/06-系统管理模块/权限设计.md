# 系统管理模块 - 权限设计

## 1. 权限系统概述

### 1.1 设计目标
- **精细化权限控制**：支持模块级、功能级、数据级的权限控制
- **灵活配置**：支持动态权限分配和调整
- **安全性**：确保数据安全和隐私保护
- **易用性**：提供直观的权限管理界面
- **扩展性**：支持未来新模块的权限集成

### 1.2 权限架构
```
权限系统架构
├── 权限模型层 (Permission Model)
│   ├── 角色 (Role)
│   ├── 权限 (Permission)
│   └── 用户权限关联 (UserPermission)
├── 权限控制层 (Permission Control)
│   ├── 模块权限 (Module Permission)
│   ├── 功能权限 (Feature Permission)
│   └── 数据权限 (Data Permission)
├── 权限验证层 (Permission Validation)
│   ├── 前端验证 (Frontend Validation)
│   ├── 后端验证 (Backend Validation)
│   └── API验证 (API Validation)
└── 权限管理界面 (Permission Management UI)
    ├── 角色管理 (Role Management)
    ├── 权限分配 (Permission Assignment)
    └── 权限审计 (Permission Audit)
```

## 2. 权限模型设计

### 2.1 核心实体

#### 2.1.1 角色 (Role)
```python
class Role(models.Model):
    name = models.CharField(max_length=100, unique=True)
    description = models.TextField(blank=True)
    is_system = models.BooleanField(default=False)  # 系统角色
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'system_roles'
```

#### 2.1.2 权限 (Permission)
```python
class Permission(models.Model):
    PERMISSION_TYPES = [
        ('module', '模块权限'),
        ('feature', '功能权限'),
        ('data', '数据权限'),
    ]
    
    name = models.CharField(max_length=100, unique=True)
    code = models.CharField(max_length=100, unique=True)  # 权限代码
    type = models.CharField(max_length=20, choices=PERMISSION_TYPES)
    module = models.CharField(max_length=50)  # 所属模块
    description = models.TextField(blank=True)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'system_permissions'
```

#### 2.1.3 用户权限关联 (UserPermission)
```python
class UserPermission(models.Model):
    user = models.ForeignKey('users.User', on_delete=models.CASCADE)
    permission = models.ForeignKey(Permission, on_delete=models.CASCADE)
    granted_by = models.ForeignKey('users.User', on_delete=models.SET_NULL, null=True, related_name='granted_permissions')
    granted_at = models.DateTimeField(auto_now_add=True)
    expires_at = models.DateTimeField(null=True, blank=True)  # 权限过期时间
    is_active = models.BooleanField(default=True)
    
    class Meta:
        db_table = 'user_permissions'
        unique_together = ['user', 'permission']
```

#### 2.1.4 用户角色关联 (UserRole)
```python
class UserRole(models.Model):
    user = models.ForeignKey('users.User', on_delete=models.CASCADE)
    role = models.ForeignKey(Role, on_delete=models.CASCADE)
    assigned_by = models.ForeignKey('users.User', on_delete=models.SET_NULL, null=True, related_name='assigned_roles')
    assigned_at = models.DateTimeField(auto_now_add=True)
    expires_at = models.DateTimeField(null=True, blank=True)
    is_active = models.BooleanField(default=True)
    
    class Meta:
        db_table = 'user_roles'
        unique_together = ['user', 'role']
```

### 2.2 数据库表结构

#### 2.2.1 角色表
```sql
CREATE TABLE system_roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    is_system BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 2.2.2 权限表
```sql
CREATE TABLE system_permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL UNIQUE,
    code VARCHAR(100) NOT NULL UNIQUE,
    type ENUM('module', 'feature', 'data') NOT NULL,
    module VARCHAR(50) NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.3 用户权限关联表
```sql
CREATE TABLE user_permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    permission_id BIGINT NOT NULL,
    granted_by BIGINT,
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NULL,
    is_active BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (permission_id) REFERENCES system_permissions(id),
    FOREIGN KEY (granted_by) REFERENCES users(id),
    UNIQUE KEY unique_user_permission (user_id, permission_id)
);
```

#### 2.2.4 用户角色关联表
```sql
CREATE TABLE user_roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    role_id BIGINT NOT NULL,
    assigned_by BIGINT,
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NULL,
    is_active BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (role_id) REFERENCES system_roles(id),
    FOREIGN KEY (assigned_by) REFERENCES users(id),
    UNIQUE KEY unique_user_role (user_id, role_id)
);
```

## 3. 权限控制机制

### 3.1 权限类型

#### 3.1.1 模块权限
- **博客模块**：`blog.access`
- **英语学习模块**：`english.access`
- **求职管理模块**：`job.access`
- **待办笔记模块**：`todo.access`
- **AI助手模块**：`ai.access`
- **系统管理模块**：`system.access`

#### 3.1.2 功能权限
```python
# 博客模块功能权限
BLOG_PERMISSIONS = [
    'blog.article.create',
    'blog.article.edit',
    'blog.article.delete',
    'blog.article.publish',
    'blog.category.manage',
    'blog.tag.manage',
    'blog.crawler.manage',
]

# 英语学习模块功能权限
ENGLISH_PERMISSIONS = [
    'english.word.manage',
    'english.expression.manage',
    'english.news.manage',
    'english.pronunciation.manage',
    'english.progress.view',
]

# 求职管理模块功能权限
JOB_PERMISSIONS = [
    'job.resume.create',
    'job.resume.edit',
    'job.resume.delete',
    'job.resume.export',
    'job.application.manage',
    'job.company.manage',
    'job.skill.manage',
]

# 待办笔记模块功能权限
TODO_PERMISSIONS = [
    'todo.task.create',
    'todo.task.edit',
    'todo.task.delete',
    'todo.note.manage',
    'todo.reminder.manage',
    'todo.statistics.view',
]

# AI助手模块功能权限
AI_PERMISSIONS = [
    'ai.chat.access',
    'ai.model.manage',
    'ai.knowledge.manage',
    'ai.recommendation.view',
]

# 系统管理模块功能权限
SYSTEM_PERMISSIONS = [
    'system.user.manage',
    'system.role.manage',
    'system.permission.manage',
    'system.module.manage',
    'system.log.view',
    'system.backup.manage',
]
```

#### 3.1.3 数据权限
```python
# 数据权限类型
DATA_PERMISSIONS = [
    'data.own',      # 只能访问自己的数据
    'data.module',   # 可以访问模块内所有数据
    'data.all',      # 可以访问所有数据
]
```

### 3.2 权限验证机制

#### 3.2.1 后端权限验证
```python
from functools import wraps
from django.http import JsonResponse
from django.core.exceptions import PermissionDenied

def require_permission(permission_code):
    """权限验证装饰器"""
    def decorator(view_func):
        @wraps(view_func)
        def wrapper(request, *args, **kwargs):
            if not request.user.has_perm(permission_code):
                raise PermissionDenied("权限不足")
            return view_func(request, *args, **kwargs)
        return wrapper
    return decorator

def require_module_access(module_name):
    """模块访问权限验证装饰器"""
    def decorator(view_func):
        @wraps(view_func)
        def wrapper(request, *args, **kwargs):
            permission_code = f"{module_name}.access"
            if not request.user.has_perm(permission_code):
                raise PermissionDenied(f"没有访问{module_name}模块的权限")
            return view_func(request, *args, **kwargs)
        return wrapper
    return decorator
```

#### 3.2.2 前端权限验证
```javascript
// 权限验证工具
class PermissionManager {
    constructor() {
        this.permissions = new Set();
        this.roles = new Set();
        this.loadPermissions();
    }

    async loadPermissions() {
        try {
            const response = await api.get('/api/v1/system/permissions/my');
            this.permissions = new Set(response.data.permissions);
            this.roles = new Set(response.data.roles);
        } catch (error) {
            console.error('加载权限失败:', error);
        }
    }

    hasPermission(permissionCode) {
        return this.permissions.has(permissionCode);
    }

    hasRole(roleName) {
        return this.roles.has(roleName);
    }

    hasModuleAccess(moduleName) {
        return this.hasPermission(`${moduleName}.access`);
    }

    // 权限指令
    checkPermission(el, binding) {
        const permissionCode = binding.value;
        if (!this.hasPermission(permissionCode)) {
            el.style.display = 'none';
        }
    }
}

// Vue指令
const permission = {
    mounted(el, binding) {
        permissionManager.checkPermission(el, binding);
    },
    updated(el, binding) {
        permissionManager.checkPermission(el, binding);
    }
};
```

### 3.3 权限管理服务

#### 3.3.1 权限服务类
```python
from typing import List, Dict, Any
from django.contrib.auth.models import Permission as DjangoPermission
from django.contrib.contenttypes.models import ContentType

class PermissionService:
    def __init__(self):
        self.permission_cache = {}
    
    def get_user_permissions(self, user_id: int) -> List[str]:
        """获取用户所有权限"""
        cache_key = f"user_permissions_{user_id}"
        if cache_key in self.permission_cache:
            return self.permission_cache[cache_key]
        
        # 从数据库获取权限
        permissions = self._load_user_permissions(user_id)
        self.permission_cache[cache_key] = permissions
        return permissions
    
    def _load_user_permissions(self, user_id: int) -> List[str]:
        """从数据库加载用户权限"""
        from .models import UserPermission, UserRole, Permission, Role
        
        # 直接权限
        direct_permissions = UserPermission.objects.filter(
            user_id=user_id,
            is_active=True
        ).values_list('permission__code', flat=True)
        
        # 角色权限
        user_roles = UserRole.objects.filter(
            user_id=user_id,
            is_active=True
        ).values_list('role_id', flat=True)
        
        role_permissions = Permission.objects.filter(
            role_permissions__role_id__in=user_roles,
            is_active=True
        ).values_list('code', flat=True)
        
        # 合并权限
        all_permissions = list(direct_permissions) + list(role_permissions)
        return list(set(all_permissions))
    
    def grant_permission(self, user_id: int, permission_code: str, granted_by: int) -> bool:
        """授予权限"""
        try:
            permission = Permission.objects.get(code=permission_code, is_active=True)
            UserPermission.objects.get_or_create(
                user_id=user_id,
                permission=permission,
                defaults={
                    'granted_by': granted_by,
                    'is_active': True
                }
            )
            # 清除缓存
            self._clear_user_cache(user_id)
            return True
        except Exception as e:
            logger.error(f"授予权限失败: {e}")
            return False
    
    def revoke_permission(self, user_id: int, permission_code: str) -> bool:
        """撤销权限"""
        try:
            UserPermission.objects.filter(
                user_id=user_id,
                permission__code=permission_code
            ).update(is_active=False)
            # 清除缓存
            self._clear_user_cache(user_id)
            return True
        except Exception as e:
            logger.error(f"撤销权限失败: {e}")
            return False
    
    def _clear_user_cache(self, user_id: int):
        """清除用户权限缓存"""
        cache_key = f"user_permissions_{user_id}"
        if cache_key in self.permission_cache:
            del self.permission_cache[cache_key]
    
    def check_permission(self, user_id: int, permission_code: str) -> bool:
        """检查用户是否有指定权限"""
        user_permissions = self.get_user_permissions(user_id)
        return permission_code in user_permissions
    
    def get_user_modules(self, user_id: int) -> List[str]:
        """获取用户可访问的模块"""
        user_permissions = self.get_user_permissions(user_id)
        modules = []
        for perm in user_permissions:
            if perm.endswith('.access'):
                module = perm.replace('.access', '')
                modules.append(module)
        return modules
```

## 4. 权限管理界面

### 4.1 权限管理组件

#### 4.1.1 角色管理组件
```vue
<template>
  <div class="role-management">
    <div class="header">
      <h2>角色管理</h2>
      <el-button type="primary" @click="showCreateRole = true">
        新建角色
      </el-button>
    </div>
    
    <el-table :data="roles" v-loading="loading">
      <el-table-column prop="name" label="角色名称" />
      <el-table-column prop="description" label="描述" />
      <el-table-column prop="is_system" label="系统角色">
        <template #default="{ row }">
          <el-tag :type="row.is_system ? 'danger' : 'info'">
            {{ row.is_system ? '是' : '否' }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="created_at" label="创建时间" />
      <el-table-column label="操作" width="200">
        <template #default="{ row }">
          <el-button size="small" @click="editRole(row)">编辑</el-button>
          <el-button size="small" @click="managePermissions(row)">权限</el-button>
          <el-button 
            size="small" 
            type="danger" 
            @click="deleteRole(row)"
            :disabled="row.is_system"
          >
            删除
          </el-button>
        </template>
      </el-table-column>
    </el-table>
    
    <!-- 创建/编辑角色对话框 -->
    <el-dialog 
      :title="editingRole ? '编辑角色' : '新建角色'"
      v-model="showCreateRole"
      width="500px"
    >
      <el-form :model="roleForm" :rules="roleRules" ref="roleFormRef">
        <el-form-item label="角色名称" prop="name">
          <el-input v-model="roleForm.name" />
        </el-form-item>
        <el-form-item label="描述" prop="description">
          <el-input 
            v-model="roleForm.description" 
            type="textarea" 
            :rows="3"
          />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="showCreateRole = false">取消</el-button>
        <el-button type="primary" @click="saveRole">保存</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script>
import { ref, reactive, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import api from '@/api/system'

export default {
  name: 'RoleManagement',
  setup() {
    const roles = ref([])
    const loading = ref(false)
    const showCreateRole = ref(false)
    const editingRole = ref(null)
    const roleFormRef = ref()
    
    const roleForm = reactive({
      name: '',
      description: ''
    })
    
    const roleRules = {
      name: [
        { required: true, message: '请输入角色名称', trigger: 'blur' }
      ]
    }
    
    const loadRoles = async () => {
      loading.value = true
      try {
        const response = await api.getRoles()
        roles.value = response.data
      } catch (error) {
        ElMessage.error('加载角色列表失败')
      } finally {
        loading.value = false
      }
    }
    
    const saveRole = async () => {
      try {
        await roleFormRef.value.validate()
        
        if (editingRole.value) {
          await api.updateRole(editingRole.value.id, roleForm)
          ElMessage.success('角色更新成功')
        } else {
          await api.createRole(roleForm)
          ElMessage.success('角色创建成功')
        }
        
        showCreateRole.value = false
        loadRoles()
      } catch (error) {
        ElMessage.error('保存失败')
      }
    }
    
    const editRole = (role) => {
      editingRole.value = role
      roleForm.name = role.name
      roleForm.description = role.description
      showCreateRole.value = true
    }
    
    const deleteRole = async (role) => {
      try {
        await ElMessageBox.confirm('确定要删除这个角色吗？', '确认删除')
        await api.deleteRole(role.id)
        ElMessage.success('角色删除成功')
        loadRoles()
      } catch (error) {
        if (error !== 'cancel') {
          ElMessage.error('删除失败')
        }
      }
    }
    
    onMounted(() => {
      loadRoles()
    })
    
    return {
      roles,
      loading,
      showCreateRole,
      editingRole,
      roleForm,
      roleFormRef,
      roleRules,
      loadRoles,
      saveRole,
      editRole,
      deleteRole
    }
  }
}
</script>
```

#### 4.1.2 权限分配组件
```vue
<template>
  <div class="permission-assignment">
    <div class="header">
      <h3>权限分配 - {{ selectedRole?.name }}</h3>
    </div>
    
    <el-tabs v-model="activeTab">
      <el-tab-pane label="模块权限" name="module">
        <el-checkbox-group v-model="selectedModulePermissions">
          <el-card 
            v-for="module in modules" 
            :key="module.name"
            class="module-card"
          >
            <template #header>
              <el-checkbox 
                :value="isModuleSelected(module.name)"
                @change="toggleModule(module.name, $event)"
              >
                {{ module.label }}
              </el-checkbox>
            </template>
            <div class="module-permissions">
              <el-checkbox 
                v-for="perm in module.permissions"
                :key="perm.code"
                :value="selectedModulePermissions.includes(perm.code)"
                @change="togglePermission(perm.code, $event)"
              >
                {{ perm.name }}
              </el-checkbox>
            </div>
          </el-card>
        </el-checkbox-group>
      </el-tab-pane>
      
      <el-tab-pane label="功能权限" name="feature">
        <el-tree
          :data="permissionTree"
          show-checkbox
          node-key="code"
          :default-checked-keys="selectedPermissions"
          @check="handlePermissionCheck"
        />
      </el-tab-pane>
    </el-tabs>
    
    <div class="actions">
      <el-button @click="$emit('close')">取消</el-button>
      <el-button type="primary" @click="savePermissions" :loading="saving">
        保存权限
      </el-button>
    </div>
  </div>
</template>

<script>
import { ref, reactive, computed, watch } from 'vue'
import { ElMessage } from 'element-plus'
import api from '@/api/system'

export default {
  name: 'PermissionAssignment',
  props: {
    roleId: {
      type: Number,
      required: true
    }
  },
  emits: ['close', 'saved'],
  setup(props, { emit }) {
    const activeTab = ref('module')
    const selectedRole = ref(null)
    const selectedPermissions = ref([])
    const saving = ref(false)
    
    const modules = ref([
      {
        name: 'blog',
        label: '博客模块',
        permissions: [
          { code: 'blog.access', name: '访问博客' },
          { code: 'blog.article.create', name: '创建文章' },
          { code: 'blog.article.edit', name: '编辑文章' },
          { code: 'blog.article.delete', name: '删除文章' },
          { code: 'blog.category.manage', name: '分类管理' },
          { code: 'blog.crawler.manage', name: '爬虫管理' }
        ]
      },
      {
        name: 'english',
        label: '英语学习模块',
        permissions: [
          { code: 'english.access', name: '访问英语学习' },
          { code: 'english.word.manage', name: '单词管理' },
          { code: 'english.expression.manage', name: '表达管理' },
          { code: 'english.news.manage', name: '新闻管理' },
          { code: 'english.pronunciation.manage', name: '发音管理' }
        ]
      },
      // ... 其他模块
    ])
    
    const selectedModulePermissions = computed({
      get() {
        return selectedPermissions.value.filter(p => 
          modules.value.some(m => 
            m.permissions.some(perm => perm.code === p)
          )
        )
      },
      set(value) {
        const otherPermissions = selectedPermissions.value.filter(p => 
          !modules.value.some(m => 
            m.permissions.some(perm => perm.code === p)
          )
        )
        selectedPermissions.value = [...otherPermissions, ...value]
      }
    })
    
    const loadRolePermissions = async () => {
      try {
        const [roleResponse, permissionsResponse] = await Promise.all([
          api.getRole(props.roleId),
          api.getRolePermissions(props.roleId)
        ])
        
        selectedRole.value = roleResponse.data
        selectedPermissions.value = permissionsResponse.data.map(p => p.code)
      } catch (error) {
        ElMessage.error('加载角色权限失败')
      }
    }
    
    const savePermissions = async () => {
      saving.value = true
      try {
        await api.updateRolePermissions(props.roleId, {
          permissions: selectedPermissions.value
        })
        ElMessage.success('权限保存成功')
        emit('saved')
      } catch (error) {
        ElMessage.error('保存权限失败')
      } finally {
        saving.value = false
      }
    }
    
    const isModuleSelected = (moduleName) => {
      return modules.value
        .find(m => m.name === moduleName)
        ?.permissions.every(p => selectedPermissions.value.includes(p.code))
    }
    
    const toggleModule = (moduleName, checked) => {
      const module = modules.value.find(m => m.name === moduleName)
      if (!module) return
      
      const modulePermissions = module.permissions.map(p => p.code)
      
      if (checked) {
        // 添加模块所有权限
        selectedPermissions.value = [
          ...selectedPermissions.value.filter(p => !modulePermissions.includes(p)),
          ...modulePermissions
        ]
      } else {
        // 移除模块所有权限
        selectedPermissions.value = selectedPermissions.value.filter(
          p => !modulePermissions.includes(p)
        )
      }
    }
    
    const togglePermission = (permissionCode, checked) => {
      if (checked) {
        if (!selectedPermissions.value.includes(permissionCode)) {
          selectedPermissions.value.push(permissionCode)
        }
      } else {
        selectedPermissions.value = selectedPermissions.value.filter(
          p => p !== permissionCode
        )
      }
    }
    
    watch(() => props.roleId, () => {
      if (props.roleId) {
        loadRolePermissions()
      }
    }, { immediate: true })
    
    return {
      activeTab,
      selectedRole,
      selectedPermissions,
      selectedModulePermissions,
      saving,
      modules,
      loadRolePermissions,
      savePermissions,
      isModuleSelected,
      toggleModule,
      togglePermission
    }
  }
}
</script>
```

## 5. 权限审计与日志

### 5.1 权限审计模型
```python
class PermissionAuditLog(models.Model):
    ACTION_TYPES = [
        ('grant', '授予权限'),
        ('revoke', '撤销权限'),
        ('assign_role', '分配角色'),
        ('remove_role', '移除角色'),
        ('create_role', '创建角色'),
        ('update_role', '更新角色'),
        ('delete_role', '删除角色'),
    ]
    
    user = models.ForeignKey('users.User', on_delete=models.CASCADE, related_name='permission_audits')
    action = models.CharField(max_length=20, choices=ACTION_TYPES)
    target_user = models.ForeignKey('users.User', on_delete=models.CASCADE, related_name='target_audits')
    permission = models.ForeignKey(Permission, on_delete=models.SET_NULL, null=True, blank=True)
    role = models.ForeignKey(Role, on_delete=models.SET_NULL, null=True, blank=True)
    details = models.JSONField(default=dict)
    ip_address = models.GenericIPAddressField()
    user_agent = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'permission_audit_logs'
        ordering = ['-created_at']
```

### 5.2 权限审计服务
```python
class PermissionAuditService:
    def __init__(self):
        self.request = None
    
    def set_request(self, request):
        """设置请求上下文"""
        self.request = request
    
    def log_permission_action(self, action: str, target_user_id: int, **kwargs):
        """记录权限操作日志"""
        try:
            PermissionAuditLog.objects.create(
                user=self.request.user,
                action=action,
                target_user_id=target_user_id,
                permission=kwargs.get('permission'),
                role=kwargs.get('role'),
                details=kwargs.get('details', {}),
                ip_address=self._get_client_ip(),
                user_agent=self.request.META.get('HTTP_USER_AGENT', '')
            )
        except Exception as e:
            logger.error(f"记录权限审计日志失败: {e}")
    
    def _get_client_ip(self):
        """获取客户端IP"""
        x_forwarded_for = self.request.META.get('HTTP_X_FORWARDED_FOR')
        if x_forwarded_for:
            ip = x_forwarded_for.split(',')[0]
        else:
            ip = self.request.META.get('REMOTE_ADDR')
        return ip
    
    def get_user_audit_logs(self, user_id: int, limit: int = 50) -> List[Dict]:
        """获取用户权限审计日志"""
        logs = PermissionAuditLog.objects.filter(
            target_user_id=user_id
        )[:limit]
        
        return [{
            'action': log.action,
            'permission': log.permission.name if log.permission else None,
            'role': log.role.name if log.role else None,
            'details': log.details,
            'created_at': log.created_at,
            'operator': log.user.username
        } for log in logs]
```

## 6. 权限安全考虑

### 6.1 安全策略
- **最小权限原则**：用户只获得完成工作所需的最小权限
- **权限分离**：敏感操作需要多个权限组合
- **定期审查**：定期审查和清理不必要的权限
- **权限过期**：设置权限过期时间，定期更新
- **操作审计**：记录所有权限相关操作

### 6.2 安全措施
```python
# 权限验证中间件
class PermissionMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response
    
    def __call__(self, request):
        # 权限验证逻辑
        if request.user.is_authenticated:
            self._validate_permissions(request)
        
        response = self.get_response(request)
        return response
    
    def _validate_permissions(self, request):
        """验证用户权限"""
        # 检查用户状态
        if not request.user.is_active:
            raise PermissionDenied("用户账户已被禁用")
        
        # 检查权限过期
        self._check_permission_expiry(request.user)
    
    def _check_permission_expiry(self, user):
        """检查权限是否过期"""
        from .models import UserPermission, UserRole
        
        # 检查直接权限过期
        expired_permissions = UserPermission.objects.filter(
            user=user,
            expires_at__lt=timezone.now(),
            is_active=True
        )
        expired_permissions.update(is_active=False)
        
        # 检查角色权限过期
        expired_roles = UserRole.objects.filter(
            user=user,
            expires_at__lt=timezone.now(),
            is_active=True
        )
        expired_roles.update(is_active=False)
```

## 7. 权限系统API

### 7.1 权限管理API
```python
# 权限管理视图
class PermissionViewSet(viewsets.ModelViewSet):
    queryset = Permission.objects.all()
    serializer_class = PermissionSerializer
    permission_classes = [IsAuthenticated, HasPermission('system.permission.manage')]
    
    @action(detail=False, methods=['get'])
    def modules(self, request):
        """获取所有模块权限"""
        modules = Permission.objects.filter(
            type='module',
            is_active=True
        ).values('module', 'name', 'code')
        
        return Response(modules)
    
    @action(detail=False, methods=['get'])
    def by_module(self, request):
        """按模块获取权限"""
        module = request.query_params.get('module')
        permissions = Permission.objects.filter(
            module=module,
            is_active=True
        )
        
        serializer = self.get_serializer(permissions, many=True)
        return Response(serializer.data)

# 角色管理视图
class RoleViewSet(viewsets.ModelViewSet):
    queryset = Role.objects.all()
    serializer_class = RoleSerializer
    permission_classes = [IsAuthenticated, HasPermission('system.role.manage')]
    
    @action(detail=True, methods=['get', 'put'])
    def permissions(self, request, pk=None):
        """管理角色权限"""
        role = self.get_object()
        
        if request.method == 'GET':
            permissions = role.permissions.all()
            serializer = PermissionSerializer(permissions, many=True)
            return Response(serializer.data)
        
        elif request.method == 'PUT':
            permission_codes = request.data.get('permissions', [])
            permissions = Permission.objects.filter(code__in=permission_codes)
            role.permissions.set(permissions)
            
            # 记录审计日志
            audit_service = PermissionAuditService()
            audit_service.set_request(request)
            audit_service.log_permission_action(
                'update_role_permissions',
                role.id,
                details={'permissions': permission_codes}
            )
            
            return Response({'message': '权限更新成功'})

# 用户权限视图
class UserPermissionViewSet(viewsets.ModelViewSet):
    queryset = UserPermission.objects.all()
    serializer_class = UserPermissionSerializer
    permission_classes = [IsAuthenticated, HasPermission('system.user.manage')]
    
    @action(detail=False, methods=['get'])
    def my_permissions(self, request):
        """获取当前用户权限"""
        permission_service = PermissionService()
        permissions = permission_service.get_user_permissions(request.user.id)
        modules = permission_service.get_user_modules(request.user.id)
        
        return Response({
            'permissions': permissions,
            'modules': modules
        })
    
    @action(detail=True, methods=['post'])
    def grant_permission(self, request, pk=None):
        """授予用户权限"""
        user = self.get_object()
        permission_code = request.data.get('permission_code')
        
        permission_service = PermissionService()
        success = permission_service.grant_permission(
            user.id,
            permission_code,
            request.user.id
        )
        
        if success:
            return Response({'message': '权限授予成功'})
        else:
            return Response({'error': '权限授予失败'}, status=400)
```

## 8. 权限系统配置

### 8.1 默认角色配置
```python
# 默认角色和权限配置
DEFAULT_ROLES = {
    'super_admin': {
        'name': '超级管理员',
        'description': '拥有所有权限',
        'is_system': True,
        'permissions': ['*']  # 所有权限
    },
    'admin': {
        'name': '管理员',
        'description': '系统管理权限',
        'is_system': True,
        'permissions': [
            'system.user.manage',
            'system.role.manage',
            'system.permission.manage',
            'system.module.manage',
            'system.log.view',
            'system.backup.manage'
        ]
    },
    'user': {
        'name': '普通用户',
        'description': '基础功能权限',
        'is_system': True,
        'permissions': [
            'blog.access',
            'blog.article.create',
            'blog.article.edit',
            'english.access',
            'todo.access',
            'todo.task.create',
            'todo.note.manage'
        ]
    }
}

# 初始化权限系统
def initialize_permission_system():
    """初始化权限系统"""
    # 创建默认权限
    create_default_permissions()
    
    # 创建默认角色
    create_default_roles()
    
    # 分配默认权限
    assign_default_permissions()

def create_default_permissions():
    """创建默认权限"""
    permissions_data = [
        # 博客模块权限
        {'code': 'blog.access', 'name': '访问博客', 'type': 'module', 'module': 'blog'},
        {'code': 'blog.article.create', 'name': '创建文章', 'type': 'feature', 'module': 'blog'},
        {'code': 'blog.article.edit', 'name': '编辑文章', 'type': 'feature', 'module': 'blog'},
        {'code': 'blog.article.delete', 'name': '删除文章', 'type': 'feature', 'module': 'blog'},
        {'code': 'blog.category.manage', 'name': '分类管理', 'type': 'feature', 'module': 'blog'},
        {'code': 'blog.crawler.manage', 'name': '爬虫管理', 'type': 'feature', 'module': 'blog'},
        
        # 英语学习模块权限
        {'code': 'english.access', 'name': '访问英语学习', 'type': 'module', 'module': 'english'},
        {'code': 'english.word.manage', 'name': '单词管理', 'type': 'feature', 'module': 'english'},
        {'code': 'english.expression.manage', 'name': '表达管理', 'type': 'feature', 'module': 'english'},
        {'code': 'english.news.manage', 'name': '新闻管理', 'type': 'feature', 'module': 'english'},
        {'code': 'english.pronunciation.manage', 'name': '发音管理', 'type': 'feature', 'module': 'english'},
        
        # 系统管理模块权限
        {'code': 'system.access', 'name': '访问系统管理', 'type': 'module', 'module': 'system'},
        {'code': 'system.user.manage', 'name': '用户管理', 'type': 'feature', 'module': 'system'},
        {'code': 'system.role.manage', 'name': '角色管理', 'type': 'feature', 'module': 'system'},
        {'code': 'system.permission.manage', 'name': '权限管理', 'type': 'feature', 'module': 'system'},
        {'code': 'system.log.view', 'name': '查看日志', 'type': 'feature', 'module': 'system'},
        {'code': 'system.backup.manage', 'name': '备份管理', 'type': 'feature', 'module': 'system'},
    ]
    
    for perm_data in permissions_data:
        Permission.objects.get_or_create(
            code=perm_data['code'],
            defaults=perm_data
        )
```

## 9. 权限系统测试

### 9.1 权限测试用例
```python
import pytest
from django.test import TestCase
from django.contrib.auth.models import User
from .models import Role, Permission, UserPermission
from .services import PermissionService

class PermissionTestCase(TestCase):
    def setUp(self):
        """测试设置"""
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass123'
        )
        self.permission_service = PermissionService()
        
        # 创建测试权限
        self.blog_access = Permission.objects.create(
            code='blog.access',
            name='访问博客',
            type='module',
            module='blog'
        )
        
        self.article_create = Permission.objects.create(
            code='blog.article.create',
            name='创建文章',
            type='feature',
            module='blog'
        )
    
    def test_grant_permission(self):
        """测试授予权限"""
        success = self.permission_service.grant_permission(
            self.user.id,
            'blog.access',
            self.user.id
        )
        
        self.assertTrue(success)
        self.assertTrue(
            self.permission_service.check_permission(self.user.id, 'blog.access')
        )
    
    def test_revoke_permission(self):
        """测试撤销权限"""
        # 先授予权限
        self.permission_service.grant_permission(
            self.user.id,
            'blog.access',
            self.user.id
        )
        
        # 撤销权限
        success = self.permission_service.revoke_permission(
            self.user.id,
            'blog.access'
        )
        
        self.assertTrue(success)
        self.assertFalse(
            self.permission_service.check_permission(self.user.id, 'blog.access')
        )
    
    def test_get_user_modules(self):
        """测试获取用户可访问模块"""
        # 授予博客模块权限
        self.permission_service.grant_permission(
            self.user.id,
            'blog.access',
            self.user.id
        )
        
        modules = self.permission_service.get_user_modules(self.user.id)
        self.assertIn('blog', modules)
    
    def test_permission_cache(self):
        """测试权限缓存"""
        # 授予权限
        self.permission_service.grant_permission(
            self.user.id,
            'blog.access',
            self.user.id
        )
        
        # 第一次获取权限（从数据库）
        permissions1 = self.permission_service.get_user_permissions(self.user.id)
        
        # 第二次获取权限（从缓存）
        permissions2 = self.permission_service.get_user_permissions(self.user.id)
        
        self.assertEqual(permissions1, permissions2)
        self.assertIn('blog.access', permissions1)
```

## 10. 总结

### 10.1 权限系统特点
- **精细化控制**：支持模块级、功能级、数据级权限控制
- **灵活配置**：支持动态权限分配和角色管理
- **安全可靠**：完善的权限验证和审计机制
- **易于扩展**：模块化设计，支持新模块权限集成
- **用户友好**：直观的权限管理界面

### 10.2 实施建议
1. **分阶段实施**：先实现基础权限控制，再逐步完善
2. **权限最小化**：遵循最小权限原则，避免权限过度分配
3. **定期审查**：建立权限定期审查机制
4. **用户培训**：对管理员进行权限管理培训
5. **监控告警**：建立权限异常监控和告警机制

### 10.3 后续优化
- **权限模板**：提供常用权限组合模板
- **批量操作**：支持批量权限分配和撤销
- **权限继承**：支持权限继承机制
- **条件权限**：支持基于条件的动态权限
- **权限分析**：提供权限使用情况分析报告
