# 待办笔记模块功能设计

## 1. 模块概述

### 1.1 模块定位
待办笔记模块是Alpha平台的核心生活管理模块之一，旨在为用户提供全面的个人任务管理、学习笔记、事件提醒和记录功能，帮助用户更好地组织学习和生活。

### 1.2 核心价值
- **任务管理**：高效的任务规划和执行跟踪
- **知识管理**：结构化的学习笔记和知识积累
- **时间管理**：智能的提醒和日程安排
- **生活记录**：个人生活和学习记录管理

### 1.3 功能架构
```
待办笔记模块
├── 待办管理
│   ├── 任务创建
│   ├── 任务分类
│   ├── 优先级管理
│   └── 进度跟踪
├── 笔记系统
│   ├── 学习笔记
│   ├── 笔记分类
│   ├── 标签管理
│   └── 搜索功能
├── 提醒系统
│   ├── 事件提醒
│   ├── 定时提醒
│   ├── 重复提醒
│   └── 智能提醒
└── 统计分析
    ├── 完成统计
    ├── 效率分析
    └── 习惯养成
```

## 2. 核心功能设计

### 2.1 待办管理系统

#### 2.1.1 任务创建
- **基本信息**：标题、描述、截止时间、优先级
- **分类标签**：工作、学习、生活、健康等分类
- **子任务**：支持任务分解和子任务管理
- **附件支持**：图片、文档、链接等附件
- **协作功能**：任务分享和协作（可选）

#### 2.1.2 任务分类
- **工作类**：工作任务、会议、项目等
- **学习类**：课程学习、阅读、练习等
- **生活类**：购物、家务、约会等
- **健康类**：运动、体检、用药等
- **自定义类**：用户自定义分类

#### 2.1.3 优先级管理
- **优先级等级**：高、中、低、无优先级
- **紧急程度**：紧急、重要、一般
- **智能排序**：基于截止时间和优先级自动排序
- **视觉标识**：不同颜色和图标标识优先级

#### 2.1.4 进度跟踪
- **完成状态**：未开始、进行中、已完成、已取消
- **进度百分比**：任务完成进度可视化
- **时间跟踪**：实际花费时间记录
- **里程碑**：重要节点标记和提醒

### 2.2 笔记管理系统

#### 2.2.1 学习笔记
- **富文本编辑**：支持格式化文本、图片、表格
- **Markdown支持**：Markdown语法编辑
- **代码块**：支持代码高亮和语法检查
- **数学公式**：LaTeX数学公式支持
- **思维导图**：可视化思维整理

#### 2.2.2 笔记分类
- **学科分类**：数学、物理、编程、语言等
- **项目分类**：项目笔记、会议记录等
- **个人分类**：日记、想法、灵感等
- **学习路径**：按学习进度组织笔记

#### 2.2.3 标签管理
- **标签系统**：多标签分类和筛选
- **标签云**：热门标签可视化
- **智能标签**：基于内容自动推荐标签
- **标签统计**：标签使用频率统计

#### 2.2.4 搜索功能
- **全文搜索**：笔记内容全文检索
- **高级搜索**：按标签、时间、分类搜索
- **搜索历史**：搜索记录保存
- **搜索建议**：智能搜索建议

### 2.3 提醒系统

#### 2.3.1 事件提醒
- **单次提醒**：一次性事件提醒
- **重复提醒**：每日、每周、每月重复
- **自定义重复**：自定义重复规则
- **提前提醒**：可设置提前提醒时间

#### 2.3.2 智能提醒
- **位置提醒**：基于位置的智能提醒
- **时间提醒**：基于时间的智能提醒
- **习惯提醒**：基于用户习惯的提醒
- **关联提醒**：基于相关任务的提醒

#### 2.3.3 提醒方式
- **应用内提醒**：应用内通知提醒
- **邮件提醒**：邮件通知
- **短信提醒**：短信通知（可选）
- **推送提醒**：手机推送通知

### 2.4 统计分析

#### 2.4.1 完成统计
- **完成率统计**：任务完成率分析
- **时间统计**：任务耗时分析
- **分类统计**：不同分类任务统计
- **趋势分析**：完成趋势图表

#### 2.4.2 效率分析
- **效率评分**：基于完成情况评分
- **时间分析**：最佳工作时间分析
- **习惯分析**：用户习惯分析
- **改进建议**：基于数据的改进建议

## 3. 技术实现

### 3.1 数据库设计

#### 3.1.1 待办任务表 (todos)
```sql
CREATE TABLE todos (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    category VARCHAR(50),
    priority ENUM('high', 'medium', 'low', 'none') DEFAULT 'medium',
    status ENUM('pending', 'in_progress', 'completed', 'cancelled') DEFAULT 'pending',
    due_date DATETIME,
    completed_at DATETIME,
    estimated_time INT, -- 分钟
    actual_time INT, -- 分钟
    parent_id BIGINT, -- 父任务ID
    tags JSON,
    attachments JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (parent_id) REFERENCES todos(id)
);
```

#### 3.1.2 笔记表 (notes)
```sql
CREATE TABLE notes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT,
    content_type ENUM('text', 'markdown', 'html') DEFAULT 'text',
    category VARCHAR(50),
    tags JSON,
    is_public BOOLEAN DEFAULT FALSE,
    view_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

#### 3.1.3 提醒表 (reminders)
```sql
CREATE TABLE reminders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    reminder_time DATETIME NOT NULL,
    repeat_type ENUM('none', 'daily', 'weekly', 'monthly', 'yearly', 'custom') DEFAULT 'none',
    repeat_config JSON, -- 重复配置
    is_active BOOLEAN DEFAULT TRUE,
    notification_type ENUM('app', 'email', 'sms', 'push') DEFAULT 'app',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

#### 3.1.4 标签表 (tags)
```sql
CREATE TABLE tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    name VARCHAR(50) NOT NULL,
    color VARCHAR(7) DEFAULT '#1890ff',
    category VARCHAR(50),
    usage_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE KEY unique_user_tag (user_id, name)
);
```

### 3.2 API设计

#### 3.2.1 待办管理API
```python
# 待办任务管理
GET    /api/v1/todo/tasks/                 # 获取任务列表
POST   /api/v1/todo/tasks/                 # 创建任务
GET    /api/v1/todo/tasks/{id}/            # 获取任务详情
PUT    /api/v1/todo/tasks/{id}/            # 更新任务
DELETE /api/v1/todo/tasks/{id}/            # 删除任务

# 任务状态管理
PUT    /api/v1/todo/tasks/{id}/status/     # 更新任务状态
PUT    /api/v1/todo/tasks/{id}/complete/   # 完成任务
PUT    /api/v1/todo/tasks/{id}/progress/   # 更新进度

# 任务统计
GET    /api/v1/todo/stats/                 # 获取任务统计
GET    /api/v1/todo/stats/completion/      # 完成率统计
GET    /api/v1/todo/stats/time/            # 时间统计
```

#### 3.2.2 笔记管理API
```python
# 笔记管理
GET    /api/v1/notes/                      # 获取笔记列表
POST   /api/v1/notes/                      # 创建笔记
GET    /api/v1/notes/{id}/                 # 获取笔记详情
PUT    /api/v1/notes/{id}/                 # 更新笔记
DELETE /api/v1/notes/{id}/                 # 删除笔记

# 笔记搜索
GET    /api/v1/notes/search/               # 搜索笔记
GET    /api/v1/notes/tags/                 # 获取标签列表
GET    /api/v1/notes/categories/           # 获取分类列表

# 笔记统计
GET    /api/v1/notes/stats/                # 笔记统计
GET    /api/v1/notes/stats/tags/           # 标签统计
```

#### 3.2.3 提醒管理API
```python
# 提醒管理
GET    /api/v1/reminders/                  # 获取提醒列表
POST   /api/v1/reminders/                  # 创建提醒
GET    /api/v1/reminders/{id}/             # 获取提醒详情
PUT    /api/v1/reminders/{id}/             # 更新提醒
DELETE /api/v1/reminders/{id}/             # 删除提醒

# 提醒触发
POST   /api/v1/reminders/{id}/trigger/     # 触发提醒
GET    /api/v1/reminders/upcoming/         # 获取即将到来的提醒
```

### 3.3 前端组件设计

#### 3.3.1 待办列表组件
```vue
<template>
  <div class="todo-list">
    <div class="todo-header">
      <h2>待办任务</h2>
      <el-button @click="showAddDialog = true" type="primary">
        添加任务
      </el-button>
    </div>
    
    <div class="todo-filters">
      <el-select v-model="filterStatus" placeholder="状态筛选">
        <el-option label="全部" value="all" />
        <el-option label="待完成" value="pending" />
        <el-option label="进行中" value="in_progress" />
        <el-option label="已完成" value="completed" />
      </el-select>
      
      <el-select v-model="filterPriority" placeholder="优先级筛选">
        <el-option label="全部" value="all" />
        <el-option label="高" value="high" />
        <el-option label="中" value="medium" />
        <el-option label="低" value="low" />
      </el-select>
      
      <el-select v-model="filterCategory" placeholder="分类筛选">
        <el-option label="全部" value="all" />
        <el-option label="工作" value="work" />
        <el-option label="学习" value="study" />
        <el-option label="生活" value="life" />
      </el-select>
    </div>
    
    <div class="todo-items">
      <div 
        v-for="task in filteredTasks" 
        :key="task.id"
        class="todo-item"
        :class="getTaskClass(task)"
      >
        <div class="task-header">
          <el-checkbox 
            v-model="task.completed" 
            @change="toggleTask(task)"
          />
          <span class="task-title" :class="{ completed: task.completed }">
            {{ task.title }}
          </span>
          <el-tag :type="getPriorityType(task.priority)" size="small">
            {{ getPriorityText(task.priority) }}
          </el-tag>
        </div>
        
        <div class="task-content" v-if="task.description">
          <p>{{ task.description }}</p>
        </div>
        
        <div class="task-meta">
          <span class="due-date" v-if="task.due_date">
            📅 {{ formatDate(task.due_date) }}
          </span>
          <span class="category" v-if="task.category">
            🏷️ {{ task.category }}
          </span>
          <span class="progress" v-if="task.progress">
            📊 {{ task.progress }}%
          </span>
        </div>
        
        <div class="task-actions">
          <el-button @click="editTask(task)" size="small">编辑</el-button>
          <el-button @click="deleteTask(task)" size="small" type="danger">
            删除
          </el-button>
        </div>
      </div>
    </div>
    
    <!-- 添加任务对话框 -->
    <el-dialog v-model="showAddDialog" title="添加任务">
      <el-form :model="newTask" label-width="80px">
        <el-form-item label="标题">
          <el-input v-model="newTask.title" placeholder="请输入任务标题" />
        </el-form-item>
        
        <el-form-item label="描述">
          <el-input 
            v-model="newTask.description" 
            type="textarea" 
            rows="3"
            placeholder="请输入任务描述"
          />
        </el-form-item>
        
        <el-form-item label="分类">
          <el-select v-model="newTask.category" placeholder="选择分类">
            <el-option label="工作" value="work" />
            <el-option label="学习" value="study" />
            <el-option label="生活" value="life" />
            <el-option label="健康" value="health" />
          </el-select>
        </el-form-item>
        
        <el-form-item label="优先级">
          <el-select v-model="newTask.priority" placeholder="选择优先级">
            <el-option label="高" value="high" />
            <el-option label="中" value="medium" />
            <el-option label="低" value="low" />
          </el-select>
        </el-form-item>
        
        <el-form-item label="截止时间">
          <el-date-picker
            v-model="newTask.due_date"
            type="datetime"
            placeholder="选择截止时间"
          />
        </el-form-item>
      </el-form>
      
      <template #footer>
        <el-button @click="showAddDialog = false">取消</el-button>
        <el-button @click="addTask" type="primary">添加</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script>
export default {
  data() {
    return {
      tasks: [],
      filterStatus: 'all',
      filterPriority: 'all',
      filterCategory: 'all',
      showAddDialog: false,
      newTask: {
        title: '',
        description: '',
        category: '',
        priority: 'medium',
        due_date: null
      }
    }
  },
  computed: {
    filteredTasks() {
      return this.tasks.filter(task => {
        const statusMatch = this.filterStatus === 'all' || task.status === this.filterStatus
        const priorityMatch = this.filterPriority === 'all' || task.priority === this.filterPriority
        const categoryMatch = this.filterCategory === 'all' || task.category === this.filterCategory
        return statusMatch && priorityMatch && categoryMatch
      })
    }
  },
  methods: {
    async loadTasks() {
      const response = await this.$api.getTasks()
      this.tasks = response.data
    },
    
    async addTask() {
      await this.$api.createTask(this.newTask)
      this.showAddDialog = false
      this.loadTasks()
      this.resetNewTask()
    },
    
    async toggleTask(task) {
      const status = task.completed ? 'completed' : 'pending'
      await this.$api.updateTaskStatus(task.id, status)
      this.loadTasks()
    },
    
    async deleteTask(task) {
      await this.$confirm('确定要删除这个任务吗？')
      await this.$api.deleteTask(task.id)
      this.loadTasks()
    },
    
    getTaskClass(task) {
      return {
        'task-completed': task.status === 'completed',
        'task-overdue': task.due_date && new Date(task.due_date) < new Date(),
        [`priority-${task.priority}`]: true
      }
    },
    
    getPriorityType(priority) {
      const types = {
        high: 'danger',
        medium: 'warning',
        low: 'info'
      }
      return types[priority] || 'info'
    },
    
    getPriorityText(priority) {
      const texts = {
        high: '高',
        medium: '中',
        low: '低'
      }
      return texts[priority] || '中'
    },
    
    formatDate(date) {
      return new Date(date).toLocaleDateString()
    },
    
    resetNewTask() {
      this.newTask = {
        title: '',
        description: '',
        category: '',
        priority: 'medium',
        due_date: null
      }
    }
  },
  
  mounted() {
    this.loadTasks()
  }
}
</script>
```

#### 3.3.2 笔记编辑器组件
```vue
<template>
  <div class="note-editor">
    <div class="editor-header">
      <el-input 
        v-model="note.title" 
        placeholder="笔记标题"
        class="title-input"
      />
      <div class="editor-actions">
        <el-button @click="saveNote" type="primary">保存</el-button>
        <el-button @click="previewNote">预览</el-button>
        <el-button @click="exportNote">导出</el-button>
      </div>
    </div>
    
    <div class="editor-toolbar">
      <el-button-group>
        <el-button @click="insertBold">粗体</el-button>
        <el-button @click="insertItalic">斜体</el-button>
        <el-button @click="insertLink">链接</el-button>
        <el-button @click="insertImage">图片</el-button>
        <el-button @click="insertCode">代码</el-button>
      </el-button-group>
      
      <el-select v-model="note.category" placeholder="选择分类">
        <el-option label="学习笔记" value="study" />
        <el-option label="工作笔记" value="work" />
        <el-option label="个人笔记" value="personal" />
        <el-option label="项目笔记" value="project" />
      </el-select>
      
      <el-select 
        v-model="note.tags" 
        multiple 
        placeholder="选择标签"
        filterable
        allow-create
      >
        <el-option 
          v-for="tag in availableTags" 
          :key="tag.id" 
          :label="tag.name" 
          :value="tag.name"
        />
      </el-select>
    </div>
    
    <div class="editor-content">
      <el-tabs v-model="activeTab">
        <el-tab-pane label="编辑" name="edit">
          <el-input
            v-model="note.content"
            type="textarea"
            :rows="20"
            placeholder="开始编写你的笔记..."
            class="content-editor"
          />
        </el-tab-pane>
        
        <el-tab-pane label="预览" name="preview">
          <div class="markdown-preview" v-html="renderedContent"></div>
        </el-tab-pane>
      </el-tabs>
    </div>
  </div>
</template>

<script>
import { marked } from 'marked'
import hljs from 'highlight.js'

export default {
  data() {
    return {
      note: {
        title: '',
        content: '',
        category: '',
        tags: []
      },
      activeTab: 'edit',
      availableTags: []
    }
  },
  computed: {
    renderedContent() {
      if (!this.note.content) return ''
      
      // 配置marked
      marked.setOptions({
        highlight: function(code, lang) {
          if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value
          }
          return hljs.highlightAuto(code).value
        }
      })
      
      return marked(this.note.content)
    }
  },
  methods: {
    async saveNote() {
      if (!this.note.title.trim()) {
        this.$message.error('请输入笔记标题')
        return
      }
      
      try {
        if (this.note.id) {
          await this.$api.updateNote(this.note.id, this.note)
        } else {
          await this.$api.createNote(this.note)
        }
        this.$message.success('保存成功')
      } catch (error) {
        this.$message.error('保存失败')
      }
    },
    
    previewNote() {
      this.activeTab = 'preview'
    },
    
    async exportNote() {
      const content = `# ${this.note.title}\n\n${this.note.content}`
      const blob = new Blob([content], { type: 'text/markdown' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `${this.note.title}.md`
      a.click()
      URL.revokeObjectURL(url)
    },
    
    insertBold() {
      this.insertText('**粗体文本**')
    },
    
    insertItalic() {
      this.insertText('*斜体文本*')
    },
    
    insertLink() {
      this.insertText('[链接文本](链接地址)')
    },
    
    insertImage() {
      this.insertText('![图片描述](图片地址)')
    },
    
    insertCode() {
      this.insertText('```\n代码块\n```')
    },
    
    insertText(text) {
      const textarea = document.querySelector('.content-editor textarea')
      const start = textarea.selectionStart
      const end = textarea.selectionEnd
      const selectedText = this.note.content.substring(start, end)
      
      this.note.content = 
        this.note.content.substring(0, start) + 
        text + 
        this.note.content.substring(end)
      
      // 设置光标位置
      this.$nextTick(() => {
        textarea.focus()
        textarea.setSelectionRange(start + text.length, start + text.length)
      })
    },
    
    async loadTags() {
      const response = await this.$api.getTags()
      this.availableTags = response.data
    }
  },
  
  mounted() {
    this.loadTags()
  }
}
</script>
```

### 3.4 提醒系统实现

#### 3.4.1 提醒服务
```python
from celery import Celery
from datetime import datetime, timedelta
import smtplib
from email.mime.text import MIMEText

app = Celery('reminders')

class ReminderService:
    def __init__(self):
        self.email_config = {
            'smtp_server': 'smtp.gmail.com',
            'smtp_port': 587,
            'username': 'your-email@gmail.com',
            'password': 'your-password'
        }
    
    def schedule_reminder(self, reminder):
        """调度提醒"""
        if reminder.repeat_type == 'none':
            # 单次提醒
            self.schedule_single_reminder(reminder)
        else:
            # 重复提醒
            self.schedule_recurring_reminder(reminder)
    
    def schedule_single_reminder(self, reminder):
        """调度单次提醒"""
        delay = (reminder.reminder_time - datetime.now()).total_seconds()
        if delay > 0:
            send_reminder.apply_async(args=[reminder.id], countdown=int(delay))
    
    def schedule_recurring_reminder(self, reminder):
        """调度重复提醒"""
        config = reminder.repeat_config or {}
        
        if reminder.repeat_type == 'daily':
            interval = 24 * 60 * 60  # 24小时
        elif reminder.repeat_type == 'weekly':
            interval = 7 * 24 * 60 * 60  # 7天
        elif reminder.repeat_type == 'monthly':
            interval = 30 * 24 * 60 * 60  # 30天
        else:
            interval = 24 * 60 * 60  # 默认每天
        
        send_recurring_reminder.apply_async(
            args=[reminder.id], 
            countdown=int(interval)
        )
    
    def send_email_reminder(self, user_email, title, description):
        """发送邮件提醒"""
        msg = MIMEText(description)
        msg['Subject'] = f'提醒: {title}'
        msg['From'] = self.email_config['username']
        msg['To'] = user_email
        
        try:
            with smtplib.SMTP(self.email_config['smtp_server'], self.email_config['smtp_port']) as server:
                server.starttls()
                server.login(self.email_config['username'], self.email_config['password'])
                server.send_message(msg)
            return True
        except Exception as e:
            print(f"发送邮件失败: {e}")
            return False
    
    def send_push_notification(self, user_id, title, description):
        """发送推送通知"""
        # 实现推送通知逻辑
        pass

@app.task
def send_reminder(reminder_id):
    """发送提醒任务"""
    from .models import Reminder, User
    
    try:
        reminder = Reminder.objects.get(id=reminder_id)
        user = User.objects.get(id=reminder.user_id)
        
        service = ReminderService()
        
        if reminder.notification_type == 'email':
            service.send_email_reminder(
                user.email, 
                reminder.title, 
                reminder.description
            )
        elif reminder.notification_type == 'push':
            service.send_push_notification(
                user.id, 
                reminder.title, 
                reminder.description
            )
        
        # 如果是重复提醒，调度下一次
        if reminder.repeat_type != 'none':
            service.schedule_recurring_reminder(reminder)
            
    except Exception as e:
        print(f"发送提醒失败: {e}")

@app.task
def send_recurring_reminder(reminder_id):
    """发送重复提醒任务"""
    send_reminder(reminder_id)
```

## 4. 性能优化

### 4.1 数据查询优化
- **索引优化**：关键字段索引优化
- **分页查询**：大量数据分页加载
- **缓存策略**：Redis缓存热点数据
- **查询优化**：复杂查询优化

### 4.2 前端性能优化
- **虚拟滚动**：长列表虚拟滚动
- **懒加载**：图片和资源懒加载
- **防抖处理**：输入防抖处理
- **缓存机制**：编辑内容缓存

### 4.3 提醒系统优化
- **队列处理**：提醒任务队列处理
- **批量处理**：批量发送提醒
- **失败重试**：发送失败重试机制
- **性能监控**：提醒系统性能监控

## 5. 安全考虑

### 5.1 数据安全
- **用户数据隔离**：不同用户数据严格隔离
- **敏感信息加密**：个人信息加密存储
- **访问控制**：API访问权限控制
- **数据备份**：定期数据备份

### 5.2 提醒安全
- **邮件安全**：邮件发送安全配置
- **推送安全**：推送通知安全验证
- **频率限制**：提醒频率限制
- **内容过滤**：提醒内容安全过滤

## 6. 扩展性设计

### 6.1 功能扩展
- **AI助手**：AI智能任务建议
- **语音输入**：语音笔记输入
- **OCR识别**：图片文字识别
- **同步功能**：多设备数据同步

### 6.2 集成扩展
- **日历集成**：与日历系统集成
- **邮件集成**：与邮件系统集成
- **云存储集成**：与云存储集成
- **第三方集成**：与第三方工具集成

## 7. 监控和统计

### 7.1 用户行为统计
- **功能使用率**：各功能使用频率
- **完成率统计**：任务完成率统计
- **使用时长**：功能使用时长统计
- **用户留存**：用户留存情况

### 7.2 系统性能监控
- **响应时间**：API响应时间监控
- **错误率**：系统错误率监控
- **资源使用**：服务器资源使用监控
- **提醒成功率**：提醒发送成功率监控

